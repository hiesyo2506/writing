# Amazon Web Service 勉強会

# 概要

## Amazon Web Service って？ ##

Amazon Web Service (以下 AWS) とは、Amazon がウェブサービスという形で提供するクラウドコンピューティングサービスです。2006 年にサービス提供を開始してから現在に至るまで、様々なコンポーネント・サービスが追加され、現在 (2013/03/11 時点) は 34 個のコンポーネント・サービスが提供されています。また、今もなお日々進化しています。

## リージョン、AZ ##

AWS の重要な概念として、リージョンと Available Zone (AZ) があります。AZ とは、要は現実世界に存在する AWS のデータセンターのことで、リージョンとはそれが存在する地域のことです。現時点 (2013/03/11 時点) で世界9ヶ所のリージョンがあります。1つのリージョン内にはデータセンターが複数拠点存在します。
AZ はお互いに地理的、電源的、ネットワーク的に分離されています。複数の AZ に分散してコンポーネントを配置することで、災害が発生してもサービスを停止させることなく運用し続けることができます。AZ 間は専用回線でつながれているので、データの転送も高速です。
リージョンが異なれば物理的により離れた土地となるので、自然災害などによるサービス停止のリスクをより一層抑えることができます。ただしリージョン間のデータ転送はインターネットを経由しますので、AZ 間に比べれば遅くなります。

!リージョン、AZのイメージ図!

## 課金方式 ##

AWS は基本的に有料のサービスです。AWS は徹底した従量制の課金体系をとっています。使いたい量、使いたい性能、使いたいサービスを指定してインフラを借りることができ、それを使った分だけ料金が発生します。
この料金体系により、1時間単位で仮想サーバを確保したり、任意の時間帯だけマシンスペックの高い仮想マシンを借りたりといった運用が可能となっています。

!例としてEC2の料金表!

## 利点と欠点 ##

AWS を導入することにより、様々なメリットを得ることができます。同時に、いくつかのデメリットも生じます。以下にメリットとデメリットをそれぞれ列挙しました。

### メリット ###

http://gihyo.jp/admin/serial/01/cosmi/0001?page=2

1. 初期コストを低く抑えることができる

AWS を利用すれば、とりあえず低いスペックのマシンでサービスを開始し、その後の負荷に応じてマシンスペックを上げたりサーバを増やしたりといったことが手軽にできます。

2. 高スペックの環境を時間単位で利用できる
3. サービスの成長にあわせて、極めてカンタンにスケールアウトできる
4. 豊富なサービス内容
5. ハードウェアの物理障害をケアする必要がない

### デメリット ###

1. AWS がサービスダウンした際に、自社で解決できない
2. 事前にコストが決まらない
3. 会員情報などを AWS に預けるリスク
4. 1つ1つのインスタンスが弱い
5. グローバルIPアドレスの使い回し

## 導入事例 ##

AWS は様々な企業、機関で採用されています。AWS を直接利用したことはなくても、AWS 上に展開されたサービスを利用したことはあるのではないでしょうか。

http://aws.amazon.com/jp/solutions/case-studies-jp/

* 株式会社東京証券取引所

東京証券取引所では、運用機能やサービス監視機能を実施するためのパッケージの検証環境としてAmazon EC2とAmazon VPCを利用し、サーバー購入と5年間の保守費用も加味した場合に100万円以上になる費用を、最終検証も踏まえ数万円に抑えることができました。

* 九州大学

九州大学は「クラウド型教育要計算機システム」のハイブリッド型クラウド環境の構築にAmazon EC2、S3,VPCを採用。大幅なコスト削減に加え、学府内のIPアドレス体系を利用でき、学府内に設定されているサーバ等との連携を容易に実現しています。

* クックパッド株式会社

クックパッド株式会社は、平常時とピーク時とのトラフィックの差、素早いサービスのリリースに対してインフラ調達を行うため、AWSを採用。Amazon VPC環境でAmazon EC2、S3を中心に活用することにより、柔軟で堅牢なシステムセキュリティを実現しています 。

* トーカ堂テレビショッピング

トーカ堂 テレビショッピングは、Amazon EC2をオンラインショップ運営に活用することで、アクセス集中にも耐えられるインフラ環境を実現すると共に大幅なコスト削減を実現できました。

* 株式会社マピオン

マピオンが提供する「ケータイ国盗り合戦」は、急激なアクセスの変化に対応し、安定したサービス提供を続けるためにAWSのフレキシブルなリソースで運用されています。

# コンポーネントの紹介 #

ここでは、AWS で提供されているコンポーネントを紹介します。すべてのコンポーネントを紹介することは紙面と時間の都合上できないので、いくつかの主要なコンポーネントに絞って紹介したいと思います。

## EC2 ##

最初に紹介するのは Amazon Elastic Compute Cloud (EC2) です。AWS の中でももっともポピュラーで、かつ汎用的なコンポーネントでしょう。
このコンポーネントは、要は仮想マシンです。好きな OS をインストールし、その上で任意のサービスを展開することができます。アプリケーションサーバとしての利用が一般的で、LAMP 構成 (死語?) でサービスを展開したり、DB 専用のマシンにしたり、はたまた何かの計算専用に利用したりと、用途は様々です。

### EC2 の魅力 ###

EC2 の魅力は、なんと言ってもその柔軟性です。サーバを増やしたり減らしたり、サーバのスペックを上げたり下げたり、ちょっとした手続きを踏むだけでカンタンに調整することができます。
また、Amazon マシンイメージ (AMI) という仕組みにより、複製を作ることも容易です。この AMI を利用することで、非常に柔軟なクラウドらしいサーバ運用が可能です。詳しくは後述します。

### 使ってみる ###

それでは、EC2 を実際に使ってみたいと思います。今回は EC2 インスタンスの追加から起動、その上で Apache HTTP Server を起動して端末から接続、最後に EC2 インスタンスの停止までを行なってみたいと思います。

1. Amazon EC2 管理コンソールを開く

https://console.aws.amazon.com/ec2/ にアクセスし、メールアドレス、パスワードを入力する。

2. ナビゲーションバーからリージョンを選択する

画面上部のナビゲーションバーから、EC2 インスタンスを配置するリージョンを選択します。今回は Tokyo リージョンを選びます。

3. Amazon EC2 コンソールの Launch Instance をクリック

インスタンスの新規作成画面に遷移します。
インスタンスの起動方法を選択することができます。今回は Quick Launch Wizard を選択します。いろんな設定を自動的に行なってくれるので、手っ取り早く始まるにはうってつけです。

4. インスタンスに名前をつける

名前は適当につけます。

5. SSH でログインするために必要な鍵のペアを作成

ここでは鍵ペアの名前をつけます。鍵ペアは複数の EC2 インスタンスで共有することができます。

6. AMI として Amazon Linux AMI 2012.09.1 を選択

7. Continue をクリック

作成した EC2 インスタンスの詳細画面が表示されます。

8. 内容を確認し、Launch をクリック

この時点で 5 で作成した鍵ペアの秘密鍵がダウンロードされています。後ほど行う ssh 接続にて使用します。

9. EC2 コンソールの Instances から 4 でつけた名前のインスタンスを選択

画面下部に EC2 インスタンスに接続するためのドメイン名が表示されています。このドメイン名と事前にダウンロードした秘密鍵を用いて EC2 インスタンスに ssh で接続します。

10. ssh で EC2 インスタンスにログイン

ユーザ名は ec2-user とします。

    ssh -i 秘密鍵 ec2-user@ドメイン名

11. Apache HTTP Server をインストール、実行

EC2 インスタンス上で、以下のコマンドを入力します。

    sudo yum -y install httpd
    sudo vi /var/www/html/index.html  # hello! と入力
    sudo /sbin/service httpd start

httpd が起動したことを確認し、ブラウザから接続すると "hello!" と表示されそうですが、残念ながらまだ接続できません。ポートがあいていないためです。

12. EC2 コンソールの Security Groups からポートの設定を変える

EC2 インスタンスが利用している Security Group を確認し、その設定を変更します。 HTTP を選択して Add Rule し、Apply Rule Changes します。これで HTTP (80番) のポートが開いたことになります。

13. ブラウザから接続

最後に、ブラウザから EC2 インスタンスへ接続します。"hello!" と表示されれば成功です。

### AWS のアカウント登録 ###

AWS のアカウントを登録するには、

1. クレジットカード番号
2. 電話番号

が必要です。
クレジットカード番号は、言わずもがな、AWS の使用料を払うために必要です。無料期間内であっても必要となります。
電話番号は本人確認のために必要です。入力フォームに電話番号を入力して確定すると、Amazon から電話がかかってきます。電話の音声案内に従って、画面に表示されている暗証願望を入力すると、本人確認が完了し、アカウント登録の次のステップへ進めるという寸法です。

## EBS ##

EC2 で注意すべき点は、データの永続化ができないという点です。AMI に含まれていないデータは、インスタンスの停止時に全て失われてしまいます。
EC2 で提供されている Elastic Block Storage (EBS) は、EC2 インスタンスからマウント可能な永続可能なストレージです。EC2 上で永続したいデータがある場合には EC2 とは別途 EBS ボリュームを確保する必要があります。
EC2 にマウントされた EBS ボリュームは、OS からはローカルなデバイスとして認識されます。

### スナップショット ###

EBS にはそのスナップショットを保存する機能があります。スナップショットは後述するストレージサービス Amazon Simple Storage Service (S3) 上に保存されます。また、スナップショットは差分で保存されるので、容量も抑えられるようになっています。

## SQS, SNS ##

Amazon Simple Queue Service (SQS) はコンピュータ間でやり取りするメッセージを格納するキューサービスです。作成できるキューの数に制限はなく、メッセージ数も無制限です。料金はリクエストごとにかかる少額の手数料 (0.0000005 米ドル/リクエスト) とデータ転送にかかる料金だけで、コストを低く抑えることができます。

Amazon Simple Notification Service (SNS) はクラウドからのメッセージ通知を提供するサービスです。通知先は HTTP/HTTPS, Email/Email-JSON, Amazon SMS, SQS から選ぶことができます。SQS は単独で使うとメッセージをポーリングする必要があります。SNS と組み合わせることでプッシュ型通知を実現できるので、無駄なポーリングが不要となります。タイミングが重要なメッセージングにおいては、SQS と SNS を組み合わせて使うべきでしょう。

### SQS のユースケース ###

動画トランスコーディング Web サイトでの利用を考えてみます。EC2、SQS、S3 を利用します。

!図!

エンドユーザーは、トランスコーディングを行う動画をこの Web サイトへアップします。動画は S3 に格納されます。と同時にバックエンドサーバ向けにメッセージを SQS キューに送信します。メッセージには動画へのポインタを含めておきます。この間、エンドユーザーが見ている画面には「変換中」などと表示しておきます。
EC2 で動くバックエンドサーバは、SQS キューからメッセージを受け取り、メッセージに格納されたポインターから S3 から動画を取得し、動画のトランスコーディングを行います。
変換された動画は S3 へ戻されます。その後バックエンドサーバは別の SQS キューに対して完了メッセージを送信します。その際、バックエンドサーバが受け取ったメッセージと同様に、変換後メッセージへのポインタをメッセージに含めておきます。
最後にこの完了メッセージを EC2 で動くフロントエンドサーバが受け取り、エンドユーザーに対して変換された動画への URL を提示し、処理は完了となります。

フロントエンドサーバとバックエンドサーバを疎結合としたことでボトルネックとなっている箇所にだけリソースをつぎ込む (EC2 インスタンスを増やす、性能を上げる) といったことが可能になります。このような疎結合を推進するインフラとなるのが SQS です。

## S3 ##

Amazon Simple Storage Service (S3) は AWS 上で展開されるストレージサービスです。シンプルなAPI、高い堅牢性と可用性が特徴です。公式の情報によれば、「指定された 1 年にわたり、99.999999999% の堅牢性と、99.99% の可用性を提供するよう設計」されているそうです。
データは「オブジェクト」として保管され、「バケット」という単位にまとめられます。「バケット」の格納先には任意のリージョンを選択できます。あるリージョンに配置されたバケットは、ユーザが明示的に移動させない限り、そのリージョンから移動することはありません。
EBS がボリュームサイズに対して料金が発生するのに対し、S3 ではデータの取得にときにだけ料金が発生します。データの格納には料金が発生しません。

また、S3 では静的な Web サイトのホスティングができます。S3 のバケットを Web サイトとして設定できます。S3 を使うことで Web サーバーをセットアップしたり、監視したり、スケールしたりといった管理の手間が不要となります。

### Reduced Redundancy Storage (RRS) ###

RRS (低冗長化ストレージ) は S3 のストレージオプションの 1 つです。素の S3 に比べて堅牢性が落ちる代わりに、料金も低く抑えられています。さほど重要でない、再生可能なデータを保存するのに向いています。画像変換により出力されたサムネイルや、トランスコードした動画データ、その他カンタンに再生可能なデータを S3 に比べて低いコストで保存しておくことができます。
公式の情報によれば、「付与された1年に対して、99.99％の堅牢性と、99.99％の可用性を提供するよう設計」されているそうです。

### Amazon Glacier ###

Amazon Glacier は S3 のストレージオプションの 1 つです。Glacier は 1 ヶ月あたり 0.01 米ドル/GB という料金となっており、S3 や RRS と比べて低いコストでデータを保管できます。ただしデータの取り出しには時間がかかる (3 〜 5 時間) ので、アクセス頻度の低いデータを保管するのに向いています。長期に渡るデータのバックアップ、過去のログデータ、その他大量データのアーカイブといった用途が考えられるのではないでしょうか。
公式の情報によれば、「指定された 1 年にわたり、99.999999999% の堅牢性と、99.99% の可用性を提供するよう設計」されているそうです。

### 使ってみる ###

S3 を使って静的 Web サイトのホスティングに挑戦してみましょう。

TODO

## RDS ##

Amazon Relational Database Service (RDS) は、クラウド上でリレーショナルデータベースをカンタンにセットアップ、運用、拡張することのできるウェブサービスです。
RDS では既存の MySQL, Oracle, SQLServer の機能を引き続き利用することができます。DB に対するツール、アプリケーションコードをほとんどそのまま流用することも可能です。もちろんデータの引継ぎもできます。

RDS を利用することで、データベースソフトウェアの更新やデータバックアップの自動化、ストレージ容量をあとから容易に拡張するといったことが可能になります。

### 使ってみる ###

TODO

## Mechanical Turk ###

Amazon Mechanical Turk (Mechanical Turk) はこれまでに紹介したサービスとは毛色の異なるサービスです。これまで紹介してきたサービスは、クラウド上のコンピュータリソースを提供するサービスでした。Mechanical Turk は人材リソースを提供するクラウドサービスです。
コンピューティング技術が発展した今日にも、コンピュータが解くより人間が解いたほうがはるかに効果的なことは存在します。例えば、写真や動画のオブジェクトの識別、不適切なコンテンツのチェック、ユーザテストなどです。このようなタスクは一時的に大量の労働力を雇用するか、放置するしかなかったでしょう。

Mechanical Turk を利用すれば、API を通じて世界中にいるオンデマンドの労働者にアクセスでき、その仕事をプログラム的にビジネスプロセスに組み込むことが可能です。まさにクラウド時代の人海戦術と呼べるでしょう。

## その他のコンポーネント ##

# ケーススタディ #
